/**
 * Lightweight i18n layer for PINBRIDGE.
 * Pure JS, no deps. Uses data-i18n and data-i18n-placeholder attributes.
 */

import { bus } from './bus.js';

const SUPPORTED_LANGS = [
    'en', 'fr', 'es', 'nl', 'de', 'it', 'pt',
    'bg', 'cs', 'da', 'et', 'fi', 'el', 'hu',
    'ga', 'hr', 'lv', 'lt', 'mt', 'pl', 'ro',
    'sk', 'sl', 'sv'
];

const base = {
    languageName: 'English',
    tagline: 'Secure. Offline. Private.',
    authChoice: 'Welcome to PINBRIDGE. Choose how you want to continue.',
    authChoiceTitle: 'Select an option to continue',
    authChoiceCreateHint: 'Set a username and PIN to start a secure vault.',
    authChoiceLoginHint: 'Unlock with your username + PIN.',
    actionCreateVault: 'Create New Vault',
    actionExistingVault: 'I already have a Vault',
    alreadyHaveVault: 'I already have a Vault',
    setupEyebrow: 'New Vault',
    setupTitle: 'Create your credentials',
    usernameLabel: 'Username',
    usernamePlaceholder: 'Your username',
    pinLabel: 'PIN code',
    pinPlaceholder: 'Enter PIN',
    confirmPinLabel: 'Confirm PIN',
    confirmPinPlaceholder: 'Repeat PIN',
    setupSubmit: 'Initialize Vault',
    setupHint: 'Notes stay on this device. Recovery Key appears once.',
    loginEyebrow: 'Access',
    loginTitle: 'Unlock',
    loginSubmit: 'Login',
    loginHint: 'If you do not have a vault, create one below.',
    recoveryLabel: 'Recovery Key (optional)',
    recoveryPlaceholder: 'Enter your recovery key',
    actionUseRecovery: 'Use Recovery Key',
    actionReset: 'Reset local',
    actionSync: 'Sync with another device',
    logout: 'Logout',
    logoutButton: 'Logout',
    lockVault: 'Lock Vault',
    palettePlaceholder: 'Type a command...',
    navAll: 'All Notes',
    navFavorites: 'Favorites',
    navTrash: 'Trash',
    mobileNotes: 'Notes',
    mobileFavorites: 'Favorites',
    mobileTrash: 'Trash',
    listTitle: 'My Notes',
    compactLabel: 'Compact: {state}',
    compactOn: 'On',
    compactOff: 'Off',
    newNoteTooltip: 'New Note',
    quickDropLabel: 'Quick Drop',
    quickDropPlaceholder: 'Quick Drop... (Enter to stash)',
    quickDropPlaceholderCollapsed: 'Quick Drop... (Enter to stash)',
    quickDropStashed: 'Stashed!',
    quickDropToast: 'Stashed to Inbox',
    searchPlaceholder: 'Search...',
    emptyList: 'No notes found.',
    folderPlaceholder: 'Folder...',
    tagsPlaceholder: '#tags...',
    noteTitlePlaceholder: 'Untitled Note',
    noteBodyPlaceholder: 'Start typing...',
    statusReady: 'Ready',
    statusManual: 'Manual save',
    statusSaving: 'Saving...',
    statusSaved: 'Saved',
    btnSave: 'Save',
    autosaveLabel: 'Auto Save: {state}',
    copyTitle: 'Copy Title',
    copyBody: 'Copy Content',
    pinNote: 'Pin Note',
    delete: 'Delete',
    deleteForever: 'Delete Forever',
    toastNoteSaved: 'Note saved',
    toastNoteEmpty: 'Note cannot be empty',
    toastNotePlaceholderBlocked: 'Please enter a title or content',
    toastCopyOk: 'Copied to clipboard',
    toastCopyFail: 'Copy failed',
    toastSessionRestored: 'Session restored',
    toastVaultLocked: 'Vault locked. Session closed.',
    toastVaultLockedIdle: 'Session closed after inactivity',
    toastVaultLoadFailed: 'Vault load failed: {error}',
    toastWelcomeBack: 'Welcome back',
    toastWelcomeNamed: 'Welcome back, {name}',
    toastRecoveryUnlocked: 'Vault unlocked with Recovery Key',
    toastRecoveryHint: 'Enter your Recovery Key and press unlock.',
    confirmResetLocal: 'Reset local data? This erases PIN and notes on this device.',
    confirmDeleteForever: 'Permanently delete? This cannot be undone.',
    authErrorInvalid: 'Invalid username or PIN.',
    authErrorMissingVault: 'We could not find your local Vault.',
    authErrorCorrupt: 'The vault looks damaged.',
    authErrorEmptyFields: 'Username and PIN are required.',
    authErrorPinMismatch: 'PIN codes do not match.',
    authErrorUsernameRequired: 'Username is required.',
    authErrorPinRequired: 'PIN is required.',
    authErrorRecoveryRequired: 'Enter your Recovery Key.',
    authErrorUserExists: 'That username already exists.',
    authRequired: 'Unlock your vault to continue.',
    toastResetDone: 'Local data cleared. Reloading...',
    btnLock: 'Lock',
    languageLabel: 'Language',
    recoveryTitle: 'Save Your Recovery Key',
    recoveryMessage: 'This is the only time you will see this key. Store it safely.',
    recoveryCopy: 'Copy',
    recoveryClose: 'I have saved my key. Continue.',
    settingsTitle: 'Portability & control',
    settingsHint: 'Export, import or reset. Everything stays on your device.',
    settingsExportJson: 'Export JSON',
    settingsExportCsv: 'Export CSV',
    settingsImportJson: 'Import JSON',
    settingsCopyBackup: 'Copy backup to clipboard',
    settingsSyncExport: 'Save backup (.json)',
    settingsSyncImport: 'Import backup (.json)',
    settingsSyncHint: 'Manual sync: export and move the file or copy/paste between devices. All stays local.',
    settingsResetWarning: 'Reset clears all local content and requires creating a new vault.',
    settingsResetCta: 'Reset Vault',
    settingsClose: 'Close',
    settingsPromptImport: 'Paste the JSON exported from PINBRIDGE:',
    settingsImportInvalid: 'Invalid format',
    settingsImportSuccess: 'Import completed. Restart session.',
    settingsImportFailed: 'Import failed: {error}',
    settingsResetConfirm: 'Reset Vault?\nThis clears notes, PIN, and session locally. Cannot be undone.',
    backupCopied: 'Backup copied to clipboard. Paste it on your other device and import.',
    loginFormTitle: 'Login',
    sessionExpired: 'Session expired. Please log in again.',
    lockToast: 'Vault locked.'
};

const translations = {
    en: { ...base },
    es: {
        ...base,
        languageName: 'Español',
        tagline: 'Seguro. Sin conexión. Privado.',
        authChoice: 'Bienvenido a PINBRIDGE. Elige cómo continuar.',
        authChoiceTitle: 'Selecciona una opción para continuar',
        authChoiceCreateHint: 'Crea usuario y PIN para iniciar un vault seguro.',
        authChoiceLoginHint: 'Desbloquea con tu usuario + PIN.',
        actionCreateVault: 'Crear nuevo Vault',
        actionExistingVault: 'Ya tengo un Vault',
        alreadyHaveVault: 'Ya tengo un Vault',
        usernameLabel: 'Usuario',
        usernamePlaceholder: 'Tu usuario',
        pinLabel: 'PIN',
        pinPlaceholder: 'Introduce tu PIN',
        confirmPinLabel: 'Confirma PIN',
        confirmPinPlaceholder: 'Repite tu PIN',
        setupTitle: 'Crea tus credenciales',
        setupSubmit: 'Inicializar Vault',
        setupHint: 'Las notas quedan en este dispositivo. La Recovery Key solo aparece una vez.',
        loginTitle: 'Desbloquear',
        loginSubmit: 'Entrar',
        loginHint: 'Si no tienes un Vault, créalo abajo.',
        recoveryLabel: 'Recovery Key (opcional)',
        recoveryPlaceholder: 'Introduce tu Recovery Key',
        actionUseRecovery: 'Usar Recovery Key',
        actionReset: 'Reset local',
        actionSync: 'Sync con otro dispositivo',
        logout: 'Cerrar sesión',
        logoutButton: 'Cerrar sesión',
        lockVault: 'Bloquear Vault',
        palettePlaceholder: 'Escribe un comando...',
        navAll: 'Notas',
        navFavorites: 'Favoritos',
        navTrash: 'Papelera',
        mobileNotes: 'Notas',
        mobileFavorites: 'Favoritos',
        mobileTrash: 'Papelera',
        listTitle: 'Mis notas',
        compactOn: 'Activado',
        compactOff: 'Desactivado',
        newNoteTooltip: 'Nueva nota',
        quickDropLabel: 'Quick Drop',
        quickDropPlaceholder: 'Quick Drop... (Enter para guardar)',
        quickDropPlaceholderCollapsed: 'Quick Drop... (Enter para guardar)',
        quickDropStashed: 'Guardado',
        quickDropToast: 'Guardado en Inbox',
        searchPlaceholder: 'Buscar...',
        emptyList: 'No hay notas.',
        folderPlaceholder: 'Carpeta...',
        noteTitlePlaceholder: 'Nota sin título',
        noteBodyPlaceholder: 'Empieza a escribir...',
        statusReady: 'Listo',
        statusManual: 'Guardado manual',
        statusSaving: 'Guardando...',
        statusSaved: 'Guardado',
        btnSave: 'Guardar',
        copyTitle: 'Copiar título',
        copyBody: 'Copiar contenido',
        pinNote: 'Anclar nota',
        delete: 'Eliminar',
        deleteForever: 'Eliminar para siempre',
        toastNoteSaved: 'Nota guardada',
        toastNoteEmpty: 'La nota no puede estar vacía',
        toastNotePlaceholderBlocked: 'Añade título o contenido',
        toastCopyOk: 'Copiado',
        toastCopyFail: 'Error al copiar',
        toastSessionRestored: 'Sesión restaurada',
        toastVaultLocked: 'Vault bloqueado. Sesión cerrada.',
        toastVaultLockedIdle: 'Sesión cerrada por inactividad',
        toastVaultLoadFailed: 'Error al cargar el Vault: {error}',
        toastWelcomeBack: 'Bienvenido de nuevo',
        toastWelcomeNamed: 'Hola {name}, bienvenido de nuevo',
        toastRecoveryUnlocked: 'Vault desbloqueado con Recovery Key',
        toastRecoveryHint: 'Introduce tu Recovery Key y pulsa desbloquear.',
        confirmResetLocal: '¿Resetear datos locales? Borra PIN y notas de este dispositivo.',
        confirmDeleteForever: '¿Eliminar permanentemente? No se puede deshacer.',
        authErrorInvalid: 'Usuario o PIN inválido.',
        authErrorMissingVault: 'No encontramos tu Vault local.',
        authErrorCorrupt: 'El Vault parece dañado.',
        authErrorEmptyFields: 'Usuario y PIN son obligatorios.',
        authErrorPinMismatch: 'Los PIN no coinciden.',
        authErrorUsernameRequired: 'El usuario es obligatorio.',
        authErrorPinRequired: 'El PIN es obligatorio.',
        authErrorRecoveryRequired: 'Introduce tu Recovery Key.',
        authErrorUserExists: 'Ese usuario ya existe.',
        authRequired: 'Desbloquea el Vault para continuar.',
        toastResetDone: 'Datos locales borrados. Recargando...',
        languageLabel: 'Idioma',
        recoveryTitle: 'Guarda tu Recovery Key',
        recoveryMessage: 'Solo verás esta clave una vez. Guárdala en un lugar seguro.',
        recoveryCopy: 'Copiar',
        recoveryClose: 'Ya la guardé. Continuar.',
        settingsTitle: 'Portabilidad y control',
        settingsHint: 'Exporta, importa o resetea. Todo ocurre en tu dispositivo.',
        settingsExportJson: 'Exportar JSON',
        settingsExportCsv: 'Exportar CSV',
        settingsImportJson: 'Importar JSON',
        settingsCopyBackup: 'Copiar backup al portapapeles',
        settingsSyncExport: 'Guardar backup (.json)',
        settingsSyncImport: 'Importar backup (.json)',
        settingsSyncHint: 'Sync manual: exporta y mueve el archivo o copia/pega entre dispositivos. Todo sigue local.',
        settingsResetWarning: 'Reset borra todo el contenido local y requerirá crear un Vault nuevo.',
        settingsResetCta: 'Reset Vault',
        settingsClose: 'Cerrar',
        settingsPromptImport: 'Pega aquí el JSON exportado de PINBRIDGE:',
        settingsImportInvalid: 'Formato inválido',
        settingsImportSuccess: 'Importación completada. Reinicia la sesión.',
        settingsImportFailed: 'Importación fallida: {error}',
        settingsResetConfirm: '¿Resetear el Vault?\nEsto borra notas, PIN y sesión local. No se puede deshacer.',
        backupCopied: 'Backup copiado al portapapeles. Pégalo en tu otro dispositivo e importa.',
        loginFormTitle: 'Login',
        sessionExpired: 'Sesión expirada. Inicia sesión de nuevo.',
        lockToast: 'Vault bloqueado.'
    },
    fr: {
        ...base,
        languageName: 'Français',
        tagline: 'Sécurisé. Hors ligne. Privé.',
        authChoice: 'Bienvenue sur PINBRIDGE. Choisissez comment continuer.',
        authChoiceTitle: 'Sélectionnez une option pour continuer',
        authChoiceCreateHint: 'Choisissez un utilisateur et un PIN pour démarrer un coffre sécurisé.',
        authChoiceLoginHint: 'Déverrouillez avec votre utilisateur + PIN.',
        actionCreateVault: 'Créer un nouveau coffre',
        actionExistingVault: 'J’ai déjà un coffre',
        alreadyHaveVault: 'J’ai déjà un coffre',
        usernameLabel: "Nom d'utilisateur",
        usernamePlaceholder: 'Votre nom',
        pinLabel: 'Code PIN',
        pinPlaceholder: 'Entrez le PIN',
        confirmPinLabel: 'Confirmez le PIN',
        confirmPinPlaceholder: 'Répétez le PIN',
        setupTitle: 'Créez vos identifiants',
        setupSubmit: 'Initialiser le coffre',
        setupHint: 'Les notes restent sur cet appareil. La clé de secours apparaît une seule fois.',
        loginTitle: 'Déverrouiller',
        loginSubmit: 'Connexion',
        loginHint: 'Si vous n’avez pas de coffre, créez-en un ci-dessous.',
        recoveryLabel: 'Clé de secours (optionnel)',
        recoveryPlaceholder: 'Entrez votre clé de secours',
        actionUseRecovery: 'Utiliser la clé de secours',
        actionReset: 'Réinitialiser local',
        actionSync: 'Synchroniser avec un autre appareil',
        logout: 'Déconnexion',
        logoutButton: 'Déconnexion',
        lockVault: 'Verrouiller le coffre',
        palettePlaceholder: 'Tapez une commande...',
        navAll: 'Notes',
        navFavorites: 'Favoris',
        navTrash: 'Corbeille',
        mobileNotes: 'Notes',
        mobileFavorites: 'Favoris',
        mobileTrash: 'Corbeille',
        listTitle: 'Mes notes',
        compactOn: 'Activé',
        compactOff: 'Désactivé',
        newNoteTooltip: 'Nouvelle note',
        quickDropPlaceholder: 'Quick Drop... (Entrée pour garder)',
        quickDropPlaceholderCollapsed: 'Quick Drop... (Entrée pour garder)',
        quickDropStashed: 'Enregistré',
        quickDropToast: 'Ajouté à Inbox',
        searchPlaceholder: 'Rechercher...',
        emptyList: 'Aucune note trouvée.',
        folderPlaceholder: 'Dossier...',
        noteTitlePlaceholder: 'Note sans titre',
        noteBodyPlaceholder: 'Commencez à écrire...',
        statusReady: 'Prêt',
        statusManual: 'Sauvegarde manuelle',
        statusSaving: 'Sauvegarde...',
        statusSaved: 'Sauvegardé',
        btnSave: 'Sauvegarder',
        copyTitle: 'Copier le titre',
        copyBody: 'Copier le contenu',
        pinNote: 'Épingler',
        delete: 'Supprimer',
        deleteForever: 'Supprimer définitivement',
        toastNoteSaved: 'Note sauvegardée',
        toastNoteEmpty: 'La note ne peut pas être vide',
        toastNotePlaceholderBlocked: 'Ajoutez un titre ou du contenu',
        toastCopyOk: 'Copié dans le presse-papiers',
        toastCopyFail: 'Échec de la copie',
        toastSessionRestored: 'Session restaurée',
        toastVaultLocked: 'Coffre verrouillé. Session fermée.',
        toastVaultLockedIdle: 'Session fermée pour inactivité',
        toastVaultLoadFailed: 'Échec du chargement du coffre : {error}',
        toastWelcomeBack: 'Bon retour',
        toastWelcomeNamed: 'Bon retour, {name}',
        toastRecoveryUnlocked: 'Coffre déverrouillé avec la clé de secours',
        toastRecoveryHint: 'Entrez votre clé de secours et validez.',
        confirmResetLocal: 'Réinitialiser les données locales ? Cela efface le PIN et les notes de cet appareil.',
        confirmDeleteForever: 'Supprimer définitivement ? Action irréversible.',
        authErrorInvalid: 'Nom d’utilisateur ou PIN invalide.',
        authErrorMissingVault: 'Coffre local introuvable.',
        authErrorCorrupt: 'Le coffre semble corrompu.',
        authErrorEmptyFields: 'Nom d’utilisateur et PIN requis.',
        authErrorPinMismatch: 'Les PIN ne correspondent pas.',
        authErrorUsernameRequired: 'Nom d’utilisateur requis.',
        authErrorPinRequired: 'PIN requis.',
        authErrorRecoveryRequired: 'Entrez votre clé de secours.',
        authRequired: 'Déverrouillez le coffre pour continuer.',
        toastResetDone: 'Données locales effacées. Rechargement...',
        languageLabel: 'Langue',
        recoveryTitle: 'Sauvegardez votre clé de secours',
        recoveryMessage: 'Vous ne verrez cette clé qu’une seule fois. Conservez-la en sécurité.',
        recoveryCopy: 'Copier',
        recoveryClose: 'Je l’ai sauvegardée. Continuer.',
        settingsTitle: 'Portabilité et contrôle',
        settingsHint: 'Exporter, importer ou réinitialiser. Tout reste sur votre appareil.',
        settingsExportJson: 'Exporter JSON',
        settingsExportCsv: 'Exporter CSV',
        settingsImportJson: 'Importer JSON',
        settingsCopyBackup: 'Copier la sauvegarde',
        settingsSyncExport: 'Sauvegarder (.json)',
        settingsSyncImport: 'Importer (.json)',
        settingsSyncHint: 'Sync manuel : exportez puis déplacez le fichier ou copiez/collez entre appareils. Tout reste local.',
        settingsResetWarning: 'La réinitialisation efface tout le contenu local et nécessite un nouveau coffre.',
        settingsResetCta: 'Réinitialiser le coffre',
        settingsClose: 'Fermer',
        settingsPromptImport: 'Collez ici le JSON exporté de PINBRIDGE :',
        settingsImportInvalid: 'Format invalide',
        settingsImportSuccess: 'Import terminé. Redémarrez la session.',
        settingsImportFailed: 'Échec de l’import : {error}',
        settingsResetConfirm: 'Réinitialiser le coffre ?\nCela efface notes, PIN et session locale. Action irréversible.',
        backupCopied: 'Sauvegarde copiée. Collez-la sur l’autre appareil et importez.',
        loginFormTitle: 'Connexion',
        sessionExpired: 'Session expirée. Connectez-vous de nouveau.',
        lockToast: 'Coffre verrouillé.'
    },
    nl: {
        ...base,
        languageName: 'Nederlands',
        tagline: 'Veilig. Offline. Privé.',
        authChoice: 'Welkom bij PINBRIDGE. Kies hoe je wilt doorgaan.',
        authChoiceTitle: 'Kies een optie om verder te gaan',
        authChoiceCreateHint: 'Stel een gebruikersnaam en PIN in voor een veilige vault.',
        authChoiceLoginHint: 'Ontgrendel met je gebruikersnaam + PIN.',
        actionCreateVault: 'Nieuwe Vault maken',
        actionExistingVault: 'Ik heb al een Vault',
        alreadyHaveVault: 'Ik heb al een Vault',
        usernameLabel: 'Gebruikersnaam',
        usernamePlaceholder: 'Je gebruikersnaam',
        pinLabel: 'PIN-code',
        pinPlaceholder: 'Voer PIN in',
        confirmPinLabel: 'Bevestig PIN',
        confirmPinPlaceholder: 'Herhaal PIN',
        setupTitle: 'Maak je inloggegevens',
        setupSubmit: 'Vault initialiseren',
        setupHint: 'Notities blijven op dit apparaat. Recovery Key verschijnt één keer.',
        loginTitle: 'Ontgrendelen',
        loginSubmit: 'Inloggen',
        loginHint: 'Nog geen vault? Maak er hieronder een.',
        recoveryLabel: 'Recovery Key (optioneel)',
        recoveryPlaceholder: 'Voer je Recovery Key in',
        actionUseRecovery: 'Recovery Key gebruiken',
        actionReset: 'Lokaal resetten',
        actionSync: 'Sync met ander apparaat',
        logout: 'Uitloggen',
        logoutButton: 'Uitloggen',
        lockVault: 'Vault vergrendelen',
        palettePlaceholder: 'Typ een commando...',
        navAll: 'Notities',
        navFavorites: 'Favorieten',
        navTrash: 'Prullenbak',
        mobileNotes: 'Notities',
        mobileFavorites: 'Favorieten',
        mobileTrash: 'Prullenbak',
        listTitle: 'Mijn notities',
        compactOn: 'Aan',
        compactOff: 'Uit',
        newNoteTooltip: 'Nieuwe notitie',
        quickDropPlaceholder: 'Quick Drop... (Enter om op te slaan)',
        quickDropPlaceholderCollapsed: 'Quick Drop... (Enter om op te slaan)',
        quickDropStashed: 'Opgeslagen',
        quickDropToast: 'Toegevoegd aan Inbox',
        searchPlaceholder: 'Zoeken...',
        emptyList: 'Geen notities gevonden.',
        folderPlaceholder: 'Map...',
        noteTitlePlaceholder: 'Naamloze notitie',
        noteBodyPlaceholder: 'Begin met typen...',
        statusReady: 'Klaar',
        statusManual: 'Handmatig opslaan',
        statusSaving: 'Opslaan...',
        statusSaved: 'Opgeslagen',
        btnSave: 'Opslaan',
        copyTitle: 'Titel kopiëren',
        copyBody: 'Inhoud kopiëren',
        pinNote: 'Notitie vastzetten',
        delete: 'Verwijderen',
        deleteForever: 'Definitief verwijderen',
        toastNoteSaved: 'Notitie opgeslagen',
        toastNoteEmpty: 'Notitie kan niet leeg zijn',
        toastNotePlaceholderBlocked: 'Voeg een titel of inhoud toe',
        toastCopyOk: 'Gekopieerd naar klembord',
        toastCopyFail: 'Kopiëren mislukt',
        toastSessionRestored: 'Sessie hersteld',
        toastVaultLocked: 'Vault vergrendeld. Sessie gesloten.',
        toastVaultLockedIdle: 'Sessie gesloten door inactiviteit',
        toastVaultLoadFailed: 'Laden van vault mislukt: {error}',
        toastWelcomeBack: 'Welkom terug',
        toastWelcomeNamed: 'Welkom terug, {name}',
        toastRecoveryUnlocked: 'Vault ontgrendeld met Recovery Key',
        toastRecoveryHint: 'Voer je Recovery Key in en ontgrendel.',
        confirmResetLocal: 'Lokale data resetten? Dit verwijdert PIN en notities op dit apparaat.',
        confirmDeleteForever: 'Definitief verwijderen? Dit kan niet ongedaan worden.',
        authErrorInvalid: 'Ongeldige gebruikersnaam of PIN.',
        authErrorMissingVault: 'Geen lokale Vault gevonden.',
        authErrorCorrupt: 'Vault lijkt beschadigd.',
        authErrorEmptyFields: 'Gebruikersnaam en PIN zijn verplicht.',
        authErrorPinMismatch: 'PIN-codes komen niet overeen.',
        authErrorUsernameRequired: 'Gebruikersnaam is verplicht.',
        authErrorPinRequired: 'PIN is verplicht.',
        authErrorRecoveryRequired: 'Voer je Recovery Key in.',
        authRequired: 'Ontgrendel de vault om door te gaan.',
        toastResetDone: 'Lokale data gewist. Herladen...',
        languageLabel: 'Taal',
        recoveryTitle: 'Bewaar je Recovery Key',
        recoveryMessage: 'Dit is de enige keer dat je deze sleutel ziet. Bewaar hem veilig.',
        recoveryCopy: 'Kopiëren',
        recoveryClose: 'Ik heb het opgeslagen. Doorgaan.',
        settingsTitle: 'Portabiliteit en controle',
        settingsHint: 'Exporteer, importeer of reset. Alles blijft op je apparaat.',
        settingsExportJson: 'JSON exporteren',
        settingsExportCsv: 'CSV exporteren',
        settingsImportJson: 'JSON importeren',
        settingsCopyBackup: 'Backup kopiëren',
        settingsSyncExport: 'Backup opslaan (.json)',
        settingsSyncImport: 'Backup importeren (.json)',
        settingsSyncHint: 'Handmatige sync: exporteer en verplaats het bestand of kopieer/plak tussen apparaten. Alles blijft lokaal.',
        settingsResetWarning: 'Reset wist alle lokale inhoud en vereist een nieuwe vault.',
        settingsResetCta: 'Vault resetten',
        settingsClose: 'Sluiten',
        settingsPromptImport: 'Plak hier de JSON die uit PINBRIDGE is geëxporteerd:',
        settingsImportInvalid: 'Ongeldig formaat',
        settingsImportSuccess: 'Import voltooid. Start de sessie opnieuw.',
        settingsImportFailed: 'Import mislukt: {error}',
        settingsResetConfirm: 'Vault resetten?\nDit verwijdert notities, PIN en sessie lokaal. Kan niet ongedaan.',
        backupCopied: 'Backup gekopieerd. Plak het op je andere apparaat en importeer.',
        loginFormTitle: 'Login',
        sessionExpired: 'Sessie verlopen. Log opnieuw in.',
        lockToast: 'Vault vergrendeld.'
    },
    de: {
        ...base,
        languageName: 'Deutsch',
        tagline: 'Sicher. Offline. Privat.',
        authChoice: 'Willkommen bei PINBRIDGE. Wähle, wie du fortfahren möchtest.',
        authChoiceTitle: 'Option wählen, um fortzufahren',
        authChoiceCreateHint: 'Benutzername und PIN festlegen, um einen sicheren Tresor zu starten.',
        authChoiceLoginHint: 'Mit Benutzername + PIN entsperren.',
        actionCreateVault: 'Neuen Tresor erstellen',
        actionExistingVault: 'Ich habe bereits einen Tresor',
        alreadyHaveVault: 'Ich habe bereits einen Tresor',
        usernameLabel: 'Benutzername',
        usernamePlaceholder: 'Dein Benutzername',
        pinLabel: 'PIN-Code',
        pinPlaceholder: 'PIN eingeben',
        confirmPinLabel: 'PIN bestätigen',
        confirmPinPlaceholder: 'PIN wiederholen',
        setupTitle: 'Erstelle deine Zugangsdaten',
        setupSubmit: 'Tresor initialisieren',
        setupHint: 'Notizen bleiben auf diesem Gerät. Recovery Key erscheint nur einmal.',
        loginTitle: 'Entsperren',
        loginSubmit: 'Anmelden',
        loginHint: 'Noch kein Tresor? Erstelle unten einen.',
        recoveryLabel: 'Recovery Key (optional)',
        recoveryPlaceholder: 'Recovery Key eingeben',
        actionUseRecovery: 'Recovery Key nutzen',
        actionReset: 'Lokal zurücksetzen',
        actionSync: 'Mit anderem Gerät syncen',
        logout: 'Abmelden',
        logoutButton: 'Abmelden',
        lockVault: 'Tresor sperren',
        palettePlaceholder: 'Befehl eingeben...',
        navAll: 'Notizen',
        navFavorites: 'Favoriten',
        navTrash: 'Papierkorb',
        mobileNotes: 'Notizen',
        mobileFavorites: 'Favoriten',
        mobileTrash: 'Papierkorb',
        listTitle: 'Meine Notizen',
        compactOn: 'An',
        compactOff: 'Aus',
        newNoteTooltip: 'Neue Notiz',
        quickDropPlaceholder: 'Quick Drop... (Enter zum Ablegen)',
        quickDropPlaceholderCollapsed: 'Quick Drop... (Enter zum Ablegen)',
        quickDropStashed: 'Gespeichert',
        quickDropToast: 'In Inbox gelegt',
        searchPlaceholder: 'Suchen...',
        emptyList: 'Keine Notizen gefunden.',
        folderPlaceholder: 'Ordner...',
        noteTitlePlaceholder: 'Unbenannte Notiz',
        noteBodyPlaceholder: 'Schreibe etwas...',
        statusReady: 'Bereit',
        statusManual: 'Manuelles Speichern',
        statusSaving: 'Speichern...',
        statusSaved: 'Gespeichert',
        btnSave: 'Speichern',
        copyTitle: 'Titel kopieren',
        copyBody: 'Inhalt kopieren',
        pinNote: 'Notiz anheften',
        delete: 'Löschen',
        deleteForever: 'Endgültig löschen',
        toastNoteSaved: 'Notiz gespeichert',
        toastNoteEmpty: 'Notiz darf nicht leer sein',
        toastNotePlaceholderBlocked: 'Füge Titel oder Inhalt hinzu',
        toastCopyOk: 'In Zwischenablage kopiert',
        toastCopyFail: 'Kopieren fehlgeschlagen',
        toastSessionRestored: 'Sitzung wiederhergestellt',
        toastVaultLocked: 'Tresor gesperrt. Sitzung geschlossen.',
        toastVaultLockedIdle: 'Sitzung wegen Inaktivität geschlossen',
        toastVaultLoadFailed: 'Tresor konnte nicht geladen werden: {error}',
        toastWelcomeBack: 'Willkommen zurück',
        toastWelcomeNamed: 'Willkommen zurück, {name}',
        toastRecoveryUnlocked: 'Tresor mit Recovery Key entsperrt',
        toastRecoveryHint: 'Recovery Key eingeben und entsperren.',
        confirmResetLocal: 'Lokale Daten zurücksetzen? Löscht PIN und Notizen auf diesem Gerät.',
        confirmDeleteForever: 'Endgültig löschen? Dies kann nicht rückgängig gemacht werden.',
        authErrorInvalid: 'Ungültiger Benutzername oder PIN.',
        authErrorMissingVault: 'Lokaler Tresor nicht gefunden.',
        authErrorCorrupt: 'Der Tresor scheint beschädigt.',
        authErrorEmptyFields: 'Benutzername und PIN sind erforderlich.',
        authErrorPinMismatch: 'PINs stimmen nicht überein.',
        authErrorUsernameRequired: 'Benutzername ist erforderlich.',
        authErrorPinRequired: 'PIN ist erforderlich.',
        authErrorRecoveryRequired: 'Recovery Key eingeben.',
        authRequired: 'Entsperre den Tresor, um fortzufahren.',
        toastResetDone: 'Lokale Daten gelöscht. Neu laden...',
        languageLabel: 'Sprache',
        recoveryTitle: 'Recovery Key sichern',
        recoveryMessage: 'Du siehst diesen Schlüssel nur einmal. Sicher aufbewahren.',
        recoveryCopy: 'Kopieren',
        recoveryClose: 'Gespeichert. Weiter.',
        settingsTitle: 'Portabilität & Kontrolle',
        settingsHint: 'Exportieren, importieren oder zurücksetzen. Alles bleibt auf deinem Gerät.',
        settingsExportJson: 'JSON exportieren',
        settingsExportCsv: 'CSV exportieren',
        settingsImportJson: 'JSON importieren',
        settingsCopyBackup: 'Backup kopieren',
        settingsSyncExport: 'Backup speichern (.json)',
        settingsSyncImport: 'Backup importieren (.json)',
        settingsSyncHint: 'Manuelles Sync: Datei exportieren und verschieben oder kopieren/einfügen. Alles bleibt lokal.',
        settingsResetWarning: 'Zurücksetzen löscht alle lokalen Inhalte und erfordert einen neuen Tresor.',
        settingsResetCta: 'Tresor zurücksetzen',
        settingsClose: 'Schließen',
        settingsPromptImport: 'Füge hier das aus PINBRIDGE exportierte JSON ein:',
        settingsImportInvalid: 'Ungültiges Format',
        settingsImportSuccess: 'Import abgeschlossen. Sitzung neu starten.',
        settingsImportFailed: 'Import fehlgeschlagen: {error}',
        settingsResetConfirm: 'Tresor zurücksetzen?\nDies löscht Notizen, PIN und Sitzung lokal. Nicht rückgängig.',
        backupCopied: 'Backup kopiert. Auf anderem Gerät einfügen und importieren.',
        loginFormTitle: 'Login',
        sessionExpired: 'Sitzung abgelaufen. Bitte erneut anmelden.',
        lockToast: 'Tresor gesperrt.'
    },
    it: {
        ...base,
        languageName: 'Italiano',
        tagline: 'Sicuro. Offline. Privato.',
        authChoice: 'Benvenuto in PINBRIDGE. Scegli come continuare.',
        authChoiceTitle: 'Seleziona un’opzione per continuare',
        authChoiceCreateHint: 'Imposta username e PIN per avviare un vault sicuro.',
        authChoiceLoginHint: 'Sblocca con username + PIN.',
        actionCreateVault: 'Crea un nuovo Vault',
        actionExistingVault: 'Ho già un Vault',
        alreadyHaveVault: 'Ho già un Vault',
        usernameLabel: 'Username',
        usernamePlaceholder: 'Il tuo username',
        pinLabel: 'PIN',
        pinPlaceholder: 'Inserisci PIN',
        confirmPinLabel: 'Conferma PIN',
        confirmPinPlaceholder: 'Ripeti PIN',
        setupTitle: 'Crea le tue credenziali',
        setupSubmit: 'Inizializza Vault',
        setupHint: 'Le note restano su questo dispositivo. La Recovery Key appare una sola volta.',
        loginTitle: 'Sblocca',
        loginSubmit: 'Accedi',
        loginHint: 'Se non hai un Vault, creane uno qui sotto.',
        recoveryLabel: 'Recovery Key (opzionale)',
        recoveryPlaceholder: 'Inserisci la Recovery Key',
        actionUseRecovery: 'Usa Recovery Key',
        actionReset: 'Reset locale',
        actionSync: 'Sync con altro dispositivo',
        logout: 'Logout',
        logoutButton: 'Logout',
        lockVault: 'Blocca Vault',
        palettePlaceholder: 'Scrivi un comando...',
        navAll: 'Note',
        navFavorites: 'Preferite',
        navTrash: 'Cestino',
        mobileNotes: 'Note',
        mobileFavorites: 'Preferite',
        mobileTrash: 'Cestino',
        listTitle: 'Le mie note',
        compactOn: 'On',
        compactOff: 'Off',
        newNoteTooltip: 'Nuova nota',
        quickDropPlaceholder: 'Quick Drop... (Invio per salvare)',
        quickDropPlaceholderCollapsed: 'Quick Drop... (Invio per salvare)',
        quickDropStashed: 'Salvato',
        quickDropToast: 'Aggiunto a Inbox',
        searchPlaceholder: 'Cerca...',
        emptyList: 'Nessuna nota trovata.',
        folderPlaceholder: 'Cartella...',
        noteTitlePlaceholder: 'Nota senza titolo',
        noteBodyPlaceholder: 'Inizia a scrivere...',
        statusReady: 'Pronto',
        statusManual: 'Salvataggio manuale',
        statusSaving: 'Salvataggio...',
        statusSaved: 'Salvato',
        btnSave: 'Salva',
        copyTitle: 'Copia titolo',
        copyBody: 'Copia contenuto',
        pinNote: 'Fissa nota',
        delete: 'Elimina',
        deleteForever: 'Elimina per sempre',
        toastNoteSaved: 'Nota salvata',
        toastNoteEmpty: 'La nota non può essere vuota',
        toastNotePlaceholderBlocked: 'Aggiungi un titolo o contenuto',
        toastCopyOk: 'Copiato negli appunti',
        toastCopyFail: 'Copia fallita',
        toastSessionRestored: 'Sessione ripristinata',
        toastVaultLocked: 'Vault bloccato. Sessione chiusa.',
        toastVaultLockedIdle: 'Sessione chiusa per inattività',
        toastVaultLoadFailed: 'Caricamento Vault fallito: {error}',
        toastWelcomeBack: 'Bentornato',
        toastWelcomeNamed: 'Bentornato, {name}',
        toastRecoveryUnlocked: 'Vault sbloccato con Recovery Key',
        toastRecoveryHint: 'Inserisci la Recovery Key e sblocca.',
        confirmResetLocal: 'Reset dati locali? Cancella PIN e note su questo dispositivo.',
        confirmDeleteForever: 'Eliminare definitivamente? Azione irreversibile.',
        authErrorInvalid: 'Username o PIN non valido.',
        authErrorMissingVault: 'Vault locale non trovato.',
        authErrorCorrupt: 'Il Vault sembra danneggiato.',
        authErrorEmptyFields: 'Username e PIN sono obbligatori.',
        authErrorPinMismatch: 'I PIN non coincidono.',
        authErrorUsernameRequired: 'Username obbligatorio.',
        authErrorPinRequired: 'PIN obbligatorio.',
        authErrorRecoveryRequired: 'Inserisci la Recovery Key.',
        authRequired: 'Sblocca il Vault per continuare.',
        toastResetDone: 'Dati locali cancellati. Ricarico...',
        languageLabel: 'Lingua',
        recoveryTitle: 'Salva la tua Recovery Key',
        recoveryMessage: 'La vedrai solo una volta. Conservala in modo sicuro.',
        recoveryCopy: 'Copia',
        recoveryClose: 'L’ho salvata. Continua.',
        settingsTitle: 'Portabilità e controllo',
        settingsHint: 'Esporta, importa o resetta. Tutto resta sul dispositivo.',
        settingsExportJson: 'Esporta JSON',
        settingsExportCsv: 'Esporta CSV',
        settingsImportJson: 'Importa JSON',
        settingsCopyBackup: 'Copia backup',
        settingsSyncExport: 'Salva backup (.json)',
        settingsSyncImport: 'Importa backup (.json)',
        settingsSyncHint: 'Sync manuale: esporta e sposta il file o copia/incolla tra dispositivi. Tutto resta locale.',
        settingsResetWarning: 'Il reset cancella tutto il contenuto locale e richiede un nuovo Vault.',
        settingsResetCta: 'Reset Vault',
        settingsClose: 'Chiudi',
        settingsPromptImport: 'Incolla qui il JSON esportato da PINBRIDGE:',
        settingsImportInvalid: 'Formato non valido',
        settingsImportSuccess: 'Import completato. Riavvia la sessione.',
        settingsImportFailed: 'Import fallito: {error}',
        settingsResetConfirm: 'Reset del Vault?\nCancella note, PIN e sessione locale. Non reversibile.',
        backupCopied: 'Backup copiato. Incollalo sull’altro dispositivo e importa.',
        loginFormTitle: 'Login',
        sessionExpired: 'Sessione scaduta. Effettua di nuovo il login.',
        lockToast: 'Vault bloccato.'
    },
    pt: {
        ...base,
        languageName: 'Português',
        tagline: 'Seguro. Offline. Privado.',
        authChoice: 'Bem-vindo ao PINBRIDGE. Escolha como continuar.',
        authChoiceTitle: 'Selecione uma opção para continuar',
        authChoiceCreateHint: 'Defina usuário e PIN para iniciar um vault seguro.',
        authChoiceLoginHint: 'Desbloqueie com usuário + PIN.',
        actionCreateVault: 'Criar novo Vault',
        actionExistingVault: 'Já tenho um Vault',
        alreadyHaveVault: 'Já tenho um Vault',
        usernameLabel: 'Usuário',
        usernamePlaceholder: 'Seu usuário',
        pinLabel: 'PIN',
        pinPlaceholder: 'Digite o PIN',
        confirmPinLabel: 'Confirme o PIN',
        confirmPinPlaceholder: 'Repita o PIN',
        setupTitle: 'Crie suas credenciais',
        setupSubmit: 'Inicializar Vault',
        setupHint: 'As notas ficam neste dispositivo. A Recovery Key aparece uma única vez.',
        loginTitle: 'Desbloquear',
        loginSubmit: 'Entrar',
        loginHint: 'Se não tem um Vault, crie abaixo.',
        recoveryLabel: 'Recovery Key (opcional)',
        recoveryPlaceholder: 'Digite sua Recovery Key',
        actionUseRecovery: 'Usar Recovery Key',
        actionReset: 'Reset local',
        actionSync: 'Sync com outro dispositivo',
        logout: 'Sair',
        logoutButton: 'Sair',
        lockVault: 'Bloquear Vault',
        palettePlaceholder: 'Digite um comando...',
        navAll: 'Notas',
        navFavorites: 'Favoritos',
        navTrash: 'Lixeira',
        mobileNotes: 'Notas',
        mobileFavorites: 'Favoritos',
        mobileTrash: 'Lixeira',
        listTitle: 'Minhas notas',
        compactOn: 'Ligado',
        compactOff: 'Desligado',
        newNoteTooltip: 'Nova nota',
        quickDropPlaceholder: 'Quick Drop... (Enter para guardar)',
        quickDropPlaceholderCollapsed: 'Quick Drop... (Enter para guardar)',
        quickDropStashed: 'Guardado',
        quickDropToast: 'Enviado para Inbox',
        searchPlaceholder: 'Buscar...',
        emptyList: 'Nenhuma nota encontrada.',
        folderPlaceholder: 'Pasta...',
        noteTitlePlaceholder: 'Nota sem título',
        noteBodyPlaceholder: 'Comece a digitar...',
        statusReady: 'Pronto',
        statusManual: 'Salvamento manual',
        statusSaving: 'Salvando...',
        statusSaved: 'Salvo',
        btnSave: 'Salvar',
        copyTitle: 'Copiar título',
        copyBody: 'Copiar conteúdo',
        pinNote: 'Fixar nota',
        delete: 'Excluir',
        deleteForever: 'Excluir para sempre',
        toastNoteSaved: 'Nota salva',
        toastNoteEmpty: 'A nota não pode estar vazia',
        toastNotePlaceholderBlocked: 'Adicione título ou conteúdo',
        toastCopyOk: 'Copiado',
        toastCopyFail: 'Falha ao copiar',
        toastSessionRestored: 'Sessão restaurada',
        toastVaultLocked: 'Vault bloqueado. Sessão encerrada.',
        toastVaultLockedIdle: 'Sessão encerrada por inatividade',
        toastVaultLoadFailed: 'Falha ao carregar Vault: {error}',
        toastWelcomeBack: 'Bem-vindo de volta',
        toastWelcomeNamed: 'Bem-vindo de volta, {name}',
        toastRecoveryUnlocked: 'Vault desbloqueado com Recovery Key',
        toastRecoveryHint: 'Digite a Recovery Key e desbloqueie.',
        confirmResetLocal: 'Resetar dados locais? Apaga PIN e notas deste dispositivo.',
        confirmDeleteForever: 'Excluir permanentemente? Não é reversível.',
        authErrorInvalid: 'Usuário ou PIN inválido.',
        authErrorMissingVault: 'Vault local não encontrado.',
        authErrorCorrupt: 'Vault parece corrompido.',
        authErrorEmptyFields: 'Usuário e PIN são obrigatórios.',
        authErrorPinMismatch: 'PINs não coincidem.',
        authErrorUsernameRequired: 'Usuário é obrigatório.',
        authErrorPinRequired: 'PIN é obrigatório.',
        authErrorRecoveryRequired: 'Digite sua Recovery Key.',
        authRequired: 'Desbloqueie o Vault para continuar.',
        toastResetDone: 'Dados locais limpos. Recarregando...',
        languageLabel: 'Idioma',
        recoveryTitle: 'Guarde sua Recovery Key',
        recoveryMessage: 'Você verá esta chave apenas uma vez. Guarde com segurança.',
        recoveryCopy: 'Copiar',
        recoveryClose: 'Já salvei. Continuar.',
        settingsTitle: 'Portabilidade e controle',
        settingsHint: 'Exporte, importe ou resete. Tudo permanece no dispositivo.',
        settingsExportJson: 'Exportar JSON',
        settingsExportCsv: 'Exportar CSV',
        settingsImportJson: 'Importar JSON',
        settingsCopyBackup: 'Copiar backup',
        settingsSyncExport: 'Salvar backup (.json)',
        settingsSyncImport: 'Importar backup (.json)',
        settingsSyncHint: 'Sync manual: exporte e mova o arquivo ou copie/cole entre dispositivos. Tudo segue local.',
        settingsResetWarning: 'Reset apaga todo conteúdo local e exige novo Vault.',
        settingsResetCta: 'Resetar Vault',
        settingsClose: 'Fechar',
        settingsPromptImport: 'Cole aqui o JSON exportado do PINBRIDGE:',
        settingsImportInvalid: 'Formato inválido',
        settingsImportSuccess: 'Importação concluída. Reinicie a sessão.',
        settingsImportFailed: 'Falha na importação: {error}',
        settingsResetConfirm: 'Resetar o Vault?\nIsso apaga notas, PIN e sessão local. Não reversível.',
        backupCopied: 'Backup copiado. Cole no outro dispositivo e importe.',
        loginFormTitle: 'Login',
        sessionExpired: 'Sessão expirada. Faça login novamente.',
        lockToast: 'Vault bloqueado.'
    }
};

const languageNames = {
    bg: 'Български',
    cs: 'Čeština',
    da: 'Dansk',
    et: 'Eesti',
    fi: 'Suomi',
    el: 'Ελληνικά',
    hu: 'Magyar',
    ga: 'Gaeilge',
    hr: 'Hrvatski',
    lv: 'Latviešu',
    lt: 'Lietuvių',
    mt: 'Malti',
    pl: 'Polski',
    ro: 'Română',
    sk: 'Slovenčina',
    sl: 'Slovenščina',
    sv: 'Svenska'
};

for (const [code, languageName] of Object.entries(languageNames)) {
    translations[code] = { ...base, languageName };
}

const LANG_KEY = 'pinbridge.lang';
let currentLang = 'en';

function resolveLanguage(lang) {
    if (lang && SUPPORTED_LANGS.includes(lang)) return lang;
    const navigatorLang = (navigator.language || navigator.userLanguage || 'en').slice(0, 2).toLowerCase();
    if (SUPPORTED_LANGS.includes(navigatorLang)) return navigatorLang;
    return 'en';
}

function format(str, params = {}) {
    return str.replace(/\{(\w+)\}/g, (_, key) => params[key] ?? `{${key}}`);
}

export const i18n = {
    init() {
        const saved = localStorage.getItem(LANG_KEY);
        currentLang = resolveLanguage(saved);
        this.apply();
        return currentLang;
    },
    t(key, params = {}) {
        const langPack = translations[currentLang] || translations.en;
        const basePack = translations.en;
        const str = langPack[key] || basePack[key] || key;
        return format(str, params);
    },
    setLanguage(lang) {
        currentLang = resolveLanguage(lang);
        localStorage.setItem(LANG_KEY, currentLang);
        this.apply();
        bus.emit('i18n:change', currentLang);
    },
    getLanguage() {
        return currentLang;
    },
    getSupported() {
        return SUPPORTED_LANGS.map(code => ({
            code,
            label: translations[code]?.languageName || code
        }));
    },
    apply(root = document) {
        root.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            el.textContent = this.t(key);
        });
        root.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            el.setAttribute('placeholder', this.t(key));
        });
        root.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            el.setAttribute('title', this.t(key));
        });
    }
};
